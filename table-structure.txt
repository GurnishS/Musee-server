create table public.users (
  user_id uuid not null default gen_random_uuid (),
  name text not null,
  subscription_type public.subscription_type null default 'free'::subscription_type,
  plan_id uuid null,
  avatar_url text null default 'https://xvpputhovrhgowfkjhfv.supabase.co/storage/v1/object/public/avatars/users/default_avatar.png'::text,
  playlists uuid[] null default '{}'::uuid[],
  favorites jsonb null default '{}'::jsonb,
  followers_count integer null default 0,
  followings_count integer null default 0,
  last_login_at timestamp without time zone null,
  settings jsonb null default '{}'::jsonb,
  created_at timestamp without time zone null default now(),
  updated_at timestamp without time zone null default now(),
  user_type public.user_type null default 'listener'::user_type,
  email text not null,
  constraint users_pkey primary key (user_id),
  constraint users_email_key unique (email),
  constraint users_plan_id_fkey foreign KEY (plan_id) references plans (plan_id),
  constraint users_user_id_fkey foreign KEY (user_id) references auth.users (id) on update CASCADE on delete CASCADE
) TABLESPACE pg_default;

create table public.artists (
  artist_id uuid not null default gen_random_uuid (),
  bio text null,
  cover_url text null default 'https://xvpputhovrhgowfkjhfv.supabase.co/storage/v1/object/public/covers/artists/default_cover.png'::text,
  genres text[] null default '{}'::text[],
  debut_year integer null,
  is_verified boolean null default false,
  social_links jsonb null default '{}'::jsonb,
  monthly_listeners integer null default 0,
  created_at timestamp without time zone null default now(),
  updated_at timestamp without time zone null default now(),
  region_id uuid not null default gen_random_uuid (),
  date_of_birth date null,
  constraint artists_pkey primary key (artist_id),
  constraint artists_artist_id_fkey foreign KEY (artist_id) references users (user_id) on update CASCADE on delete CASCADE,
  constraint artists_region_id_fkey foreign KEY (region_id) references regions (region_id) on update CASCADE on delete set null
) TABLESPACE pg_default;



create trigger set_user_type_to_artist
after INSERT on artists for EACH row
execute FUNCTION handle_artist_user_type_changes ();

create trigger set_user_type_to_listener
after DELETE on artists for EACH row
execute FUNCTION handle_artist_user_type_changes ();



create table public.albums (
  album_id uuid not null default gen_random_uuid (),
  title text not null,
  release_date date null,
  description text null,
  cover_url text null default '''https://xvpputhovrhgowfkjhfv.supabase.co/storage/v1/object/public/covers/albums/default_cover.png''::text'::text,
  genres text[] null default '{}'::text[],
  total_tracks integer null default 0,
  likes_count bigint null,
  created_at timestamp without time zone null default now(),
  updated_at timestamp without time zone null default now(),
  is_published boolean null default false,
  duration integer null,
  constraint albums_pkey primary key (album_id)
) TABLESPACE pg_default;



create table public.album_artists (
  id uuid not null default gen_random_uuid (),
  album_id uuid not null default gen_random_uuid (),
  artist_id uuid not null default gen_random_uuid (),
  role public.artist_role not null default 'viewer'::artist_role,
  constraint album_artists_pkey primary key (id),
  constraint album_artists_artist_id_key unique (artist_id),
  constraint album_artists_album_id_fkey foreign KEY (album_id) references albums (album_id) on update CASCADE on delete CASCADE,
  constraint album_artists_artist_id_fkey foreign KEY (artist_id) references artists (artist_id) on update CASCADE on delete CASCADE
) TABLESPACE pg_default;



create table public.playlists (
  playlist_id uuid not null default gen_random_uuid (),
  name text not null,
  creator_id uuid null,
  is_public boolean null default true,
  description text null,
  cover_url text null default 'https://xvpputhovrhgowfkjhfv.supabase.co/storage/v1/object/public/covers/playlists/default_cover.png'::text,
  genres text[] null default '{}'::text[],
  likes_count bigint null,
  total_tracks integer null default 0,
  created_at timestamp without time zone null default now(),
  updated_at timestamp without time zone null default now(),
  duration integer null,
  constraint playlists_pkey primary key (playlist_id),
  constraint playlists_creator_id_fkey foreign KEY (creator_id) references users (user_id) on delete CASCADE
) TABLESPACE pg_default;



create table public.playlist_tracks (
  id bigint generated by default as identity not null,
  playlist_id uuid not null default gen_random_uuid (),
  track_id uuid not null default gen_random_uuid (),
  constraint playlist_tracks_pkey primary key (id),
  constraint playlist_tracks_playlist_id_fkey foreign KEY (playlist_id) references playlists (playlist_id) on update CASCADE on delete CASCADE,
  constraint playlist_tracks_track_id_fkey foreign KEY (track_id) references tracks (track_id) on update CASCADE on delete CASCADE
) TABLESPACE pg_default;



create table public.tracks (
  track_id uuid not null default gen_random_uuid (),
  title text not null,
  album_id uuid not null,
  cover_url text not null default 'https://xvpputhovrhgowfkjhfv.supabase.co/storage/v1/object/public/covers/tracks/default_cover.png'::text,
  lyrics_url text null,
  play_count bigint null default 0,
  is_explicit boolean null default false,
  likes_count integer null default 0,
  popularity_score double precision null default 0,
  created_at timestamp without time zone null default now(),
  updated_at timestamp without time zone null default now(),
  video_url text null,
  is_published boolean null default false,
  duration integer not null,
  constraint tracks_pkey primary key (track_id),
  constraint tracks_album_id_fkey foreign KEY (album_id) references albums (album_id) on delete CASCADE
) TABLESPACE pg_default;



create table public.track_artists (
  track_id uuid not null default gen_random_uuid (),
  artist_id uuid not null default gen_random_uuid (),
  created_at timestamp with time zone not null default now(),
  role public.artist_role not null default 'viewer'::artist_role,
  id uuid not null default gen_random_uuid (),
  constraint track_artists_pkey primary key (id),
  constraint track_artists_artist_id_key unique (artist_id),
  constraint track_artists_artist_id_key1 unique (artist_id),
  constraint track_artists_artist_id_fkey foreign KEY (artist_id) references artists (artist_id) on update CASCADE on delete CASCADE,
  constraint track_artists_track_id_fkey foreign KEY (track_id) references tracks (track_id) on update CASCADE on delete CASCADE
) TABLESPACE pg_default;



create table public.track_audios (
  id uuid not null default gen_random_uuid (),
  track_id uuid not null default gen_random_uuid (),
  ext public.audio_exts not null,
  bitrate smallint not null,
  path text not null,
  created_at timestamp with time zone not null default now(),
  constraint audio_info_pkey primary key (id),
  constraint audio_info_track_id_fkey foreign KEY (track_id) references tracks (track_id) on update CASCADE on delete CASCADE
) TABLESPACE pg_default;



create table public.regions (
  region_id uuid not null default gen_random_uuid (),
  created_at timestamp with time zone not null default now(),
  code text not null,
  name text not null,
  country_id uuid not null default gen_random_uuid (),
  constraint regions_pkey primary key (region_id),
  constraint regions_code_key unique (code),
  constraint regions_country_id_fkey foreign KEY (country_id) references countries (country_id) on update CASCADE on delete CASCADE
) TABLESPACE pg_default;



create table public.countries (
  country_id uuid not null default gen_random_uuid (),
  code text not null,
  name text not null,
  created_at timestamp with time zone not null default now(),
  constraint countries_pkey primary key (country_id),
  constraint countries_code_key unique (code)
) TABLESPACE pg_default;